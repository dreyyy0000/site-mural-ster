<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL,
    listAll,
    deleteObject
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA94lQivhMSjYf44S-QrWmRVg6DynxPt68",
    authDomain: "mural-ster.firebaseapp.com",
    projectId: "mural-ster",
    storageBucket: "mural-ster.appspot.com",
    messagingSenderId: "585327762238",
    appId: "1:585327762238:web:f48900f0a5942188c7ea6f",
    measurementId: "G-YKHGYEH0R5"
  };

  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);

  const uploadInput = document.getElementById('uploadInput');
  const gallery = document.getElementById('gallery');
  const takePhotoBtn = document.getElementById('takePhotoBtn');

  const userId = localStorage.getItem('userId') || crypto.randomUUID();
  localStorage.setItem('userId', userId);

  takePhotoBtn.addEventListener('click', () => {
    uploadInput.click();
  });

  uploadInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const fileName = `${userId}-${Date.now()}.jpg`;
    const imageRef = ref(storage, `fotos/${fileName}`);
    await uploadBytes(imageRef, file);

    const url = await getDownloadURL(imageRef);
    showPhoto(url, true, imageRef.fullPath);

    uploadInput.value = '';
  });

  async function loadImages() {
    gallery.innerHTML = '';
    const listRef = ref(storage, 'fotos');
    const res = await listAll(listRef);

    // Mostra fotos mais novas primeiro
    const items = res.items.reverse();

    for (const item of items) {
      const url = await getDownloadURL(item);
      const isOwner = item.name.startsWith(userId);
      showPhoto(url, isOwner, item.fullPath);
    }
  }

  function showPhoto(url, isOwner, path) {
    const div = document.createElement('div');
    div.className = 'photo';

    const img = document.createElement('img');
    img.src = url;
    img.alt = "Foto enviada";

    div.appendChild(img);

    if (isOwner) {
      const btn = document.createElement('button');
      btn.className = 'delete-btn';
      btn.textContent = 'Ã—';
      btn.onclick = () => deletePhoto(path);
      div.appendChild(btn);
    }

    // Adiciona a nova foto no topo da galeria
    gallery.prepend(div);
  }

  async function deletePhoto(path) {
    const photoRef = ref(storage, path);
    await deleteObject(photoRef);
    loadImages();
  }

  loadImages();
</script>
