<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL,
    listAll,
    deleteObject
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA94lQivhMSjYf44S-QrWmRVg6DynxPt68",
    authDomain: "mural-ster.firebaseapp.com",
    projectId: "mural-ster",
    storageBucket: "mural-ster.appspot.com",
    messagingSenderId: "585327762238",
    appId: "1:585327762238:web:f48900f0a5942188c7ea6f",
    measurementId: "G-YKHGYEH0R5"
  };

  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);

  const uploadInput = document.getElementById('uploadInput');
  const gallery = document.getElementById('gallery');
  const takePhotoBtn = document.getElementById('takePhotoBtn');

  // ID único salvo no navegador
  const userId = localStorage.getItem('userId') || crypto.randomUUID();
  localStorage.setItem('userId', userId);

  // Clicar no botão = abrir câmera
  takePhotoBtn.addEventListener('click', () => {
    uploadInput.click();
  });

  // Enviar foto
  uploadInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const fileName = `${userId}-${Date.now()}.jpg`;
    const filePath = `fotos/${fileName}`;
    const imageRef = ref(storage, filePath);

    try {
      await uploadBytes(imageRef, file);
      const url = await getDownloadURL(imageRef);
      addPhotoToFeed(url, true, filePath);
      uploadInput.value = ''; // limpa input
    } catch (error) {
      console.error('Erro ao enviar imagem:', error);
    }
  });

  // Carrega todas as fotos da galeria
  async function loadImages() {
    gallery.innerHTML = '';
    const listRef = ref(storage, 'fotos');

    try {
      const res = await listAll(listRef);
      const items = res.items.reverse();

      for (const item of items) {
        const url = await getDownloadURL(item);
        const isOwner = item.name.startsWith(userId);
        addPhotoToFeed(url, isOwner, item.fullPath);
      }
    } catch (error) {
      console.error('Erro ao carregar galeria:', error);
    }
  }

  // Mostra uma foto na galeria
  function addPhotoToFeed(url, isOwner, path) {
    const div = document.createElement('div');
    div.className = 'photo';

    const img = document.createElement('img');
    img.src = url;
    img.alt = "Foto enviada";

    div.appendChild(img);

    if (isOwner) {
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = '×';
      deleteBtn.addEventListener('click', async () => {
        await deletePhoto(path);
      });
      div.appendChild(deleteBtn);
    }

    gallery.prepend(div);
  }

  // Apagar imagem
  async function deletePhoto(path) {
    const photoRef = ref(storage, path);
    try {
      await deleteObject(photoRef);
      loadImages();
    } catch (error) {
      console.error('Erro ao deletar imagem:', error);
    }
  }

  // Iniciar galeria
  loadImages();
</script>
