<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL,
    listAll,
    deleteObject
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA94lQivhMSjYf44S-QrWmRVg6DynxPt68",
    authDomain: "mural-ster.firebaseapp.com",
    projectId: "mural-ster",
    storageBucket: "mural-ster.appspot.com",
    messagingSenderId: "585327762238",
    appId: "1:585327762238:web:f48900f0a5942188c7ea6f",
    measurementId: "G-YKHGYEH0R5"
  };

  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);

  const uploadInput = document.getElementById('uploadInput');
  const gallery = document.getElementById('gallery');
  const takePhotoBtn = document.getElementById('takePhotoBtn');

  const userId = localStorage.getItem('userId') || crypto.randomUUID();
  localStorage.setItem('userId', userId);

  takePhotoBtn.addEventListener('click', () => {
    uploadInput.click();
  });

  uploadInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const fileName = `${userId}-${Date.now()}.jpg`;
    const imageRef = ref(storage, `fotos/${fileName}`);
    await uploadBytes(imageRef, file);

    const url = await getDownloadURL(imageRef);
    addPhotoToFeed(url, true, imageRef.fullPath);

    uploadInput.value = '';
  });

  async function loadImages() {
    gallery.innerHTML = '';
    const listRef = ref(storage, 'fotos');
    const res = await listAll(listRef);

    // Exibe as imagens mais recentes primeiro
    for (const item of res.items.reverse()) {
      const url = await getDownloadURL(item);
      const isOwner = item.name.startsWith(userId);
      addPhotoToFeed(url, isOwner, item.fullPath);
    }
  }

  function addPhotoToFeed(url, isOwner, path) {
    const div = document.createElement('div');
    div.className = 'photo';
    div.innerHTML = `
      <img src="${url}" alt="Foto enviada" />
      ${isOwner ? `<button class="delete-btn" onclick="deletePhoto('${path}')">Ã—</button>` : ''}
    `;
    // Adiciona a nova imagem no topo do feed
    gallery.prepend(div);
  }

  window.deletePhoto = async (path) => {
    const photoRef = ref(storage, path);
    await deleteObject(photoRef);
    loadImages();
  };

  loadImages();
</script>
